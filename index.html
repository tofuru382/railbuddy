<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RailBuddy Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    .device { max-width: 420px; height: 100vh; margin: auto; display: flex; flex-direction: column; background: #fff; border: 1px solid #ccc; border-radius: 8px; }
    .chat { flex: 1; padding: 12px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .row { display: flex; }
    .bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; }
    .user { justify-content: flex-end; }
    .user .bubble { background: #4285f4; color: #fff; border-top-right-radius: 4px; }
    .bot .bubble { background: #eee; color: #333; border-top-left-radius: 4px; }
    footer { display: flex; gap: 6px; padding: 10px; border-top: 1px solid #ddd; }
    input { flex: 1; padding: 10px; border-radius: 14px; border: 1px solid #ccc; font-size: 14px; }
    button { border: none; padding: 0 14px; border-radius: 14px; font-size: 14px; cursor: pointer; }
    .btnBlue { background: #4285f4; color: #fff; }
    .btnBlue:hover { background: #3367d6; }
    .btnGhost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnGhost:hover { background: #f5f5f5; }
    .cameraWrap { padding: 8px; background: #fafafa; border-bottom: 1px solid #ddd; }
    video { width: 100%; border-radius: 6px; background: #000; }
  </style>
</head>
<body>
  <div class="device">
    <div class="cameraWrap">
      <video id="camera" autoplay playsinline muted></video><br>
      <button id="capture" class="btnGhost"><i class="fas fa-camera"></i> Capture</button>
    </div>

    <div class="chat" id="chat">
      <div class="row bot"><div class="bubble">ðŸ‘‹ Welcome! Point your camera at a sign or type a question.</div></div>
    </div>

    <footer>
      <input id="userInput" placeholder="Type your message..." maxlength="300" autocomplete="off"/>
      <button id="send" class="btnBlue"><i class="fas fa-paper-plane"></i></button>
      <button id="micBtn" class="btnGhost"><i class="fas fa-microphone"></i></button>
    </footer>
  </div>

  <canvas id="snapshot" style="display:none;"></canvas>

  <script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("userInput");
    const sendBtn = document.getElementById("send");
    const micBtn = document.getElementById("micBtn");
    const captureBtn = document.getElementById("capture");
    const video = document.getElementById("camera");
    const canvas = document.getElementById("snapshot");

    let lastImageData = null;

    function addMsg(text, who="user") {
      const row = document.createElement("div");
      row.className = "row " + who;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = text;
      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    async function askGPT(question) {
      const messages = [
        { role: "system", content: "You are a train assistant for foreign tourists in Japan." },
        { role: "user", content: question }
      ];

      if (lastImageData) {
        messages.push({
          role: "user",
          content: "Here is the sign I captured (image base64, truncated): " + lastImageData.substring(0,50) + "..."
        });
      }

      try {
        const resp = await fetch("https://api.tomoharu-furuya.workers.dev", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ model: "gpt-4o-mini", messages })
        });
        const data = await resp.json();
        if (data.choices && data.choices[0].message) {
          return data.choices[0].message.content;
        } else {
          return "âš ï¸ Unexpected response: " + JSON.stringify(data);
        }
      } catch (err) {
        console.error(err);
        return "âš ï¸ Error fetching response.";
      }
    }

    sendBtn.onclick = async () => {
      const text = input.value.trim();
      if (!text) return;
      if (text.length > 300) { addMsg("âš ï¸ Message too long (max 300 characters).", "bot"); return; }
      addMsg(text, "user");
      input.value = "";
      const answer = await askGPT(text);
      addMsg(answer, "bot");
    };

    // ðŸŽ¤ Mic support
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    try {
      if (window.SpeechRecognition) {
        recognition = new window.SpeechRecognition();
        recognition.lang = "en-US";
        recognition.onresult = async (e) => {
          const transcript = e.results[0][0].transcript;
          addMsg(transcript, "user");
          const answer = await askGPT(transcript);
          addMsg(answer, "bot");
        };
      } else {
        micBtn.disabled = true;
        micBtn.title = "Speech recognition not supported";
      }
    } catch {
      micBtn.disabled = true;
      micBtn.title = "Speech recognition not supported";
    }
    micBtn.onclick = () => { if (recognition) recognition.start(); };

    // ðŸ“¸ Camera
    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        console.error("Camera error", err);
      }
    }
    initCamera();

    captureBtn.onclick = () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      lastImageData = canvas.toDataURL("image/jpeg", 0.8);
      addMsg(`<img src="${lastImageData}" style="max-width:100%;border-radius:6px">`, "user");
    };
  </script>
</body>
</html>
