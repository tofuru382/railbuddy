<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Train Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    html, body {
      touch-action: none;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .device {
      width: 100%;
      max-width: 420px;
      height: 100%;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .topbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      background: #fff;
      border-bottom: 4px solid #eee;
      padding: 10px 14px;
      position: relative;
      z-index: 2;
    }
    .menu-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #555; }
    .menu {
      display: none;
      position: absolute;
      top: 44px;
      right: 10px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
      min-width: 180px;
      z-index: 5;
      padding: 6px 0;
    }
    .menu button {
      display: block;
      width: 100%;
      border: none;
      background: #fff;
      padding: 10px 14px;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: background .2s ease;
    }
    .menu button:hover { background: #f5f5f5; }
    .menu .lampRow { display: flex; align-items: center; gap: 6px; padding: 6px 14px; font-size: 13px; color: #555; }
    .lamp { width: 10px; height: 10px; border-radius: 50%; background: #bbb; }
    .lamp.allowed { background: #4caf50; }
    .lamp.denied { background: #f44336; }

    .previewWrap { background: #fafafa; border-bottom: 1px solid #eee; padding: 12px; }
    .previewBox {
      width: 100%;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      height: 220px;
      transition: height .4s ease;
      margin-bottom: 12px;
    }
    .previewBox.expanded { height: 400px; width: 100%; border-radius: 8px; }
    .previewBox.expanded video { object-fit: contain; width: 100%; height: 100%; }
    video { width: 100%; height: 100%; object-fit: cover; }

    .previewControls, .inputBar {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      gap: 10px;
      padding: 0 10px;
    }

    .btnControl, .btnBlue, .btnGhost {
      flex: 1;
      border-radius: 14px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
    }
    .btnControl {
      border: none;
      width: 44.5px;
      height: 44.5px;
      transition: background .2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .btnControl.blue { background: #4285f4; color: #fff; }
    .btnControl.blue:hover { background: #3367d6; }
    .btnControl.ghost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnControl.ghost:hover { background: #f5f5f5; }

    .chat {
      flex: 1;
      overflow: auto;
      padding: 12px;
      background: #fff;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-bottom: calc(80px + env(safe-area-inset-bottom));
    }

    .row { display: flex; }
    .bubble {
      max-width: 75%;
      padding: 8px 12px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.4;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
    }
    .bot .bubble { background: #f0f0f0; color: #333; border-top-left-radius: 4px; }
    .user { justify-content: flex-end; }
    .user .bubble { background: #4285f4; color: #fff; border-top-right-radius: 4px; }

    .inputWrap { flex: 3; position: relative; display: flex; align-items: center; }
    .textIn {
      flex: 1;
      border-radius: 14px;
      padding: 12px 36px 12px 12px;
      border: 1px solid #ddd;
      font-size: 15px;
      background: #fff;
    }
    .textIn::placeholder { color: #aaa; }
    .micIcon { position: absolute; right: 10px; background: none; border: none; font-size: 16px; color: #666; cursor: pointer; }

    .btnBlue, .btnGhost { padding: 10px 0; }
    .btnBlue { background: #4285f4; color: #fff; border: none; }
    .btnBlue:hover { background: #3367d6; }
    .btnGhost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnGhost:hover { background: #f5f5f5; }

    .mapFrame { border: 0; border-radius: 6px; width: 100%; height: 120px; margin-top: 4px; }

    .typing { opacity: 0.8; font-style: italic; }
  </style>
</head>

<body>
  <div class="device">
    <div class="topbar">
      <button class="menu-btn" id="menuBtn"><i class="fas fa-ellipsis-h"></i></button>
      <div class="menu" id="menu">
        <button id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
        <button id="clearBtn"><i class="fas fa-trash"></i> Clear Messages</button>
        <div class="lampRow"><div id="cameraLamp" class="lamp"></div> Camera</div>
        <div class="lampRow"><div id="locationLamp" class="lamp"></div> Location</div>
      </div>
    </div>

    <section class="previewWrap">
      <div id="previewBox" class="previewBox">
        <video id="camera" autoplay playsinline muted></video>
      </div>
      <div class="previewControls">
        <button id="zoomIn" class="btnControl ghost"><i class="fas fa-search-plus"></i></button>
        <button id="zoomOut" class="btnControl ghost"><i class="fas fa-search-minus"></i></button>
        <button id="flicker" class="btnControl blue" style="font-size:12px;">Anti-Flicker</button>
        <button id="toggleSize" class="btnControl ghost"><i class="fas fa-expand-arrows-alt"></i></button>
        <button id="switchCamera" class="btnControl ghost"><i class="fas fa-sync-alt"></i></button>
      </div>
    </section>

    <main id="chat" class="chat">
      <div class="row bot">
        <div class="bubble">Welcome! Iâ€™ll help you read departure boards, tickets, or gate messages. Capture the sign, and Iâ€™ll guide you step by step.</div>
      </div>
    </main>

    <footer class="inputBar">
      <div class="inputWrap">
        <input id="userInput" class="textIn" placeholder="Messageâ€¦" autocomplete="off" />
        <button id="micBtn" class="micIcon"><i class="fas fa-microphone"></i></button>
      </div>
      <button id="capture" class="btnGhost"><i class="fas fa-camera"></i></button>
      <button id="send" class="btnBlue"><i class="fas fa-paper-plane"></i></button>
    </footer>
  </div>

  <canvas id="snapshot" style="display:none;"></canvas>

  <script>
const chat=document.getElementById('chat');
const input=document.getElementById('userInput');
const canvas=document.getElementById('snapshot');
const captureBtn=document.getElementById('capture');
const sendBtn=document.getElementById('send');
const micBtn=document.getElementById('micBtn');
const cameraLamp=document.getElementById('cameraLamp');
const locationLamp=document.getElementById('locationLamp');
const menu=document.getElementById('menu');
const menuBtn=document.getElementById('menuBtn');
const clearBtn=document.getElementById('clearBtn');
const toggleSizeBtn=document.getElementById('toggleSize');
const switchBtn=document.getElementById('switchCamera');
const flickerBtn=document.getElementById('flicker');
const video=document.getElementById('camera');
let stream, usingRear=true, currentTrack, typingTimer=null;

const SYSTEM_PROMPT=`You are a Japanese station staff helping foreign visitors.
If only an image is sent, confirm receipt and wait for a question.
Use the image and GPS data to answer questions.
Always give the conclusion first.
Respond simply and clearly in English.`;

let chatHistory=JSON.parse(localStorage.getItem("chatHistory")||"[]");
if(chatHistory.length===0){chatHistory.push({role:"system",content:SYSTEM_PROMPT});}
function saveHistory(){localStorage.setItem("chatHistory",JSON.stringify(chatHistory.slice(-20)));}
function clearMemory(){chatHistory=[{role:"system",content:SYSTEM_PROMPT}];saveHistory();}

// --- message helpers ---
function addMsg(html,who='user'){
  const row=document.createElement('div');
  row.className='row '+(who==='user'?'user':'bot');
  const b=document.createElement('div');
  b.className='bubble';
  b.innerHTML=html;
  row.appendChild(b);
  chat.appendChild(row);
  chat.scrollTop=chat.scrollHeight;
  return b;
}

// --- typing animation ---
function showTyping(){
  const row=document.createElement('div');row.className='row bot';
  const b=document.createElement('div');b.className='bubble typing';b.textContent='Typing';
  row.appendChild(b);chat.appendChild(row);chat.scrollTop=chat.scrollHeight;
  let dots=0;typingTimer=setInterval(()=>{dots=(dots+1)%4;b.textContent='Typing'+'.'.repeat(dots);},500);
  return row;
}
function hideTyping(row){if(typingTimer){clearInterval(typingTimer);typingTimer=null;}if(row&&row.parentElement)row.remove();}

// --- prepare messages (multimodal ok) ---
function sanitizeMessages(){return chatHistory.slice(-20);}

// --- GPT request (non-streaming) ---
async function askGPT(){
  const typingRow=showTyping();
  try{
    const resp=await fetch("/api",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({model:"gpt-4o-mini",messages:sanitizeMessages()})
    });
    const data=await resp.json();
    hideTyping(typingRow);
    if(!resp.ok||data.error){
      const msg=data?.error?.message||data?.error||("HTTP "+resp.status);
      addMsg("âš ï¸ API error: "+msg,"bot");
      return;
    }
    const answer=data.choices?.[0]?.message?.content||"âš ï¸ No response.";
    addMsg(answer,"bot");
    chatHistory.push({role:"assistant",content:answer});
    saveHistory();
  }catch(e){hideTyping(typingRow);addMsg("âš ï¸ Network or API error: "+e.message,"bot");}
}

// --- camera init ---
async function initCamera(facing='environment'){
  try{
    if(stream)stream.getTracks().forEach(t=>t.stop());
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:facing}}});
    cameraLamp.classList.add('allowed');
  }catch{
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:true});
      cameraLamp.classList.add('allowed');
    }catch(err){
      cameraLamp.classList.add('denied');
      addMsg("ðŸ“· Camera error: "+err.message,'bot');
    }
  }
  if(stream){video.srcObject=stream;currentTrack=stream.getVideoTracks()[0];}
}

// --- capture photo + GPS + send ---
async function captureNow(){
  if(!stream){addMsg("Camera not ready.","bot");return;}
  const w=video.videoWidth||720,h=video.videoHeight||1280;
  canvas.width=w;canvas.height=h;
  const ctx=canvas.getContext("2d");ctx.drawImage(video,0,0,w,h);
  const dataURL=canvas.toDataURL("image/jpeg",0.9);

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat=pos.coords.latitude,lon=pos.coords.longitude;
    locationLamp.classList.add("allowed");
    let addr=`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,
        {headers:{"User-Agent":"TrainAssistant/1.0"}});
      const j=await r.json();
      if(j.display_name)addr=j.display_name;
    }catch{}
    addMsg(`<div><img src="${dataURL}" style="max-width:100%;border-radius:6px"></div>
            <div class='meta'><i class='fas fa-map-marker-alt'></i> ${addr}</div>`,'user');

    // send real image + text
    chatHistory.push({
      role:"user",
      content:[
        {type:"text",text:`Photo taken near ${addr} (${lat},${lon})`},
        {type:"image_url",image_url:{url:dataURL}}
      ]
    });
    saveHistory();
    await askGPT();
  },err=>{
    locationLamp.classList.add("denied");
    addMsg(`<div><img src="${dataURL}" style="max-width:100%;border-radius:6px"></div>
            <div class='meta'><i class='fas fa-map-marker-alt'></i> No location (${err.message})</div>`,'user');
    chatHistory.push({
      role:"user",
      content:[
        {type:"text",text:"Photo taken (no GPS location)"},
        {type:"image_url",image_url:{url:dataURL}}
      ]
    });
    saveHistory();
    askGPT();
  },{enableHighAccuracy:true,timeout:6000});
}

// --- send text ---
sendBtn.onclick=async()=>{
  const t=input.value.trim();
  if(!t)return;
  addMsg(t,'user');
  chatHistory.push({role:"user",content:t});
  saveHistory();
  input.value='';
  await askGPT();
};

// --- controls ---
toggleSizeBtn.onclick=()=>{document.getElementById('previewBox').classList.toggle("expanded");};
switchBtn.onclick=()=>{usingRear=!usingRear;initCamera(usingRear?'environment':'user');};
flickerBtn.onclick=()=>addMsg("Anti-flicker toggle pressed.","bot");
clearBtn.onclick=()=>{chat.innerHTML='';clearMemory();menu.style.display='none';};
menuBtn.onclick=()=>menu.style.display=menu.style.display==='block'?'none':'block';
document.addEventListener('click',e=>{
  if(!menu.contains(e.target)&&e.target!==menuBtn)menu.style.display='none';
});
captureBtn.onclick=captureNow;
document.getElementById('zoomIn').onclick=()=>applyZoom(+0.2);
document.getElementById('zoomOut').onclick=()=>applyZoom(-0.2);

// --- zoom ---
async function applyZoom(delta){
  if(!currentTrack)return;
  const caps=currentTrack.getCapabilities?.()||{};
  if(!caps.zoom)return;
  const s=currentTrack.getSettings?.()||{};
  const next=Math.min(caps.zoom.max??1,Math.max(caps.zoom.min??1,(s.zoom??1)+delta));
  try{await currentTrack.applyConstraints({advanced:[{zoom:next}]});}catch{}
}

// --- speech recognition ---
const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
if(SR){
  const rec=new SR();
  rec.lang='en-US';
  rec.onresult=async e=>{
    const t=e.results[0][0].transcript;
    addMsg(t,'user');
    chatHistory.push({role:"user",content:t});
    saveHistory();
    await askGPT();
  };
  rec.onerror=e=>addMsg("ðŸŽ¤ Error: "+e.error,'bot');
  micBtn.onclick=()=>{rec.start();addMsg("ðŸŽ¤ Listening...","bot");};
}else{
  micBtn.disabled=true;micBtn.title="Speech recognition not supported";
}

// --- init ---
initCamera('environment');
</script>

</body>
</html>
