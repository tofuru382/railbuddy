<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Train Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    html, body { touch-action: none; height: 100%; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: #f5f5f5; color: #333;
      display: flex; align-items: center; justify-content: center;
    }
    .device {
      width: 100%; max-width: 420px; height: 100%;
      background: #fff; border: 1px solid #ddd; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .08);
      display: flex; flex-direction: column;
      overflow: hidden; position: relative;
      padding: env(safe-area-inset-top) env(safe-area-inset-right)
               env(safe-area-inset-bottom) env(safe-area-inset-left);
    }
    .topbar { display: flex; justify-content: flex-end; align-items: center;
      background: #fff; border-bottom: 1px solid #eee; padding: 10px 14px;
      position: relative; z-index: 2; }
    .menu-btn { background: none; border: none; font-size: 18px;
      cursor: pointer; color: #555; position: relative; z-index: 3; }
    .menu { display: none; position: absolute; top: 44px; right: 10px;
      background: #fff; border: 1px solid #ddd; border-radius: 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,.1); min-width: 180px; z-index: 5; padding: 6px 0; }
    .menu button { display: block; width: 100%; border: none; background: #fff;
      padding: 10px 14px; text-align: left; cursor: pointer; font-size: 14px;
      color: #333; transition: background .2s ease; }
    .menu button:hover { background: #f5f5f5; }
    .menu .lampRow { display: flex; align-items: center; gap: 6px; padding: 6px 14px; font-size: 13px; color: #555; }
    .lamp { width: 10px; height: 10px; border-radius: 50%; background: #bbb; }
    .lamp.allowed { background: #4caf50; }
    .lamp.denied { background: #f44336; }
    .previewWrap { background: #fafafa; border-bottom: 1px solid #eee; padding: 12px; }
    .previewBox { width: 100%; background: #000; border-radius: 8px; overflow: hidden;
      height: 220px; transition: height 0.4s ease; margin-bottom: 12px; }
    .previewBox.expanded { height: 400px; width: 100%; border-radius: 8px; }
    .previewBox.expanded video { object-fit: contain; width: 100%; height: 100%; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .previewControls, .inputBar { display: flex; flex-direction: row;
      justify-content: space-between; gap: 10px; padding: 0 10px; }
    .btnControl, .btnBlue, .btnGhost { flex: 1; border-radius: 14px; font-weight: 600; font-size: 14px; cursor: pointer; text-align: center; }
    .btnControl { border: none; width: 44.5px; height: 44.5px; transition: background .2s ease;
      display: flex; align-items: center; justify-content: center; }
    .btnControl.blue { background: #4285f4; color: #fff; }
    .btnControl.blue:hover { background: #3367d6; }
    .btnControl.ghost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnControl.ghost:hover { background: #f5f5f5; }
    .chat { flex: 1; overflow: auto; padding: 12px; background: #fff;
      display: flex; flex-direction: column; gap: 8px; }
    .row { display: flex; }
    .bubble { max-width: 75%; padding: 8px 12px; border-radius: 12px;
      font-size: 13px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .bot .bubble { background: #f0f0f0; color: #333; border-top-left-radius: 4px; }
    .user { justify-content: flex-end; }
    .user .bubble { background: #4285f4; color: #fff; border-top-right-radius: 4px; }
    .inputWrap { flex: 3; position: relative; display: flex; align-items: center; }
    .textIn { flex: 1; border-radius: 14px; padding: 12px 36px 12px 12px;
      border: 1px solid #ddd; font-size: 15px; background: #fff; }
    .textIn::placeholder { color: #aaa; }
    .micIcon { position: absolute; right: 10px; background: none; border: none;
      font-size: 16px; color: #666; cursor: pointer; }
    .btnBlue, .btnGhost { padding: 10px 0; }
    .btnBlue { background: #4285f4; color: #fff; border: none; }
    .btnBlue:hover { background: #3367d6; }
    .btnGhost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnGhost:hover { background: #f5f5f5; }
    .mapFrame { border: 0; border-radius: 6px; width: 100%; height: 120px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="device">
    <div class="topbar">
      <button class="menu-btn" id="menuBtn"><i class="fas fa-ellipsis-h"></i></button>
      <div class="menu" id="menu">
        <button id="clearBtn"><i class="fas fa-trash"></i> Clear Messages</button>
        <div class="lampRow"><div id="cameraLamp" class="lamp"></div> Camera</div>
        <div class="lampRow"><div id="locationLamp" class="lamp"></div> Location</div>
      </div>
    </div>

    <section class="previewWrap">
      <div id="previewBox" class="previewBox">
        <video id="camera" autoplay playsinline muted></video>
      </div>
      <div class="previewControls">
        <button id="toggleSize" class="btnControl ghost"><i class="fas fa-expand-arrows-alt"></i></button>
        <button id="switchCamera" class="btnControl ghost"><i class="fas fa-sync-alt"></i></button>
        <button id="capture" class="btnControl blue"><i class="fas fa-camera"></i></button>
      </div>
    </section>

    <main id="chat" class="chat">
      <div class="row bot">
        <div class="bubble">Welcome! Iâ€™m a station staff assistant. Please capture a sign or ask your question.</div>
      </div>
    </main>

    <footer class="inputBar">
      <div class="inputWrap">
        <input id="userInput" class="textIn" placeholder="Ask about a signâ€¦" autocomplete="off" />
        <button id="micBtn" class="micIcon"><i class="fas fa-microphone"></i></button>
      </div>
      <button id="send" class="btnBlue"><i class="fas fa-paper-plane"></i></button>
    </footer>
  </div>

  <canvas id="snapshot" style="display:none;"></canvas>

  <script>
    const video=document.getElementById('camera');
    const chat=document.getElementById('chat');
    const input=document.getElementById('userInput');
    const canvas=document.getElementById('snapshot');
    const captureBtn=document.getElementById('capture');
    const sendBtn=document.getElementById('send');
    const micBtn=document.getElementById('micBtn');
    const cameraLamp=document.getElementById('cameraLamp');
    const locationLamp=document.getElementById('locationLamp');
    const toggleSizeBtn=document.getElementById('toggleSize');
    const switchBtn=document.getElementById('switchCamera');
    const clearBtn=document.getElementById('clearBtn');
    const menuBtn=document.getElementById('menuBtn');
    const menu=document.getElementById('menu');

    let stream; let usingRear=true; let isCapturing=false;

    function addMsg(html,who='user'){
      const row=document.createElement('div');
      row.className='row '+(who==='user'?'user':'bot');
      const b=document.createElement('div'); b.className='bubble'; b.innerHTML=html;
      row.appendChild(b);
      chat.appendChild(row);
      chat.scrollTop=chat.scrollHeight;
    }

    async function initCamera(facing='environment'){
      try{
        if(stream){ stream.getTracks().forEach(t=>t.stop()); }
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:facing}}});
        cameraLamp.classList.add('allowed');
      }catch{
        try{ stream=await navigator.mediaDevices.getUserMedia({video:true}); cameraLamp.classList.add('allowed'); }
        catch(err){ cameraLamp.classList.add('denied'); addMsg("ðŸ“· Camera error: "+err.message,'bot'); }
      }
      if(stream){ video.srcObject=stream; }
    }

    async function captureNow(){
      if(isCapturing){ addMsg("â³ Please wait 2 seconds before taking another photo.","bot"); return; }
      if(!stream){ addMsg("Camera not ready.","bot"); return; }

      isCapturing=true; captureBtn.disabled=true; captureBtn.style.opacity=0.5;

      canvas.width=video.videoWidth||720; canvas.height=video.videoHeight||1280;
      const ctx=canvas.getContext("2d"); ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const dataURL=canvas.toDataURL("image/jpeg",0.9);

      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude;
        locationLamp.classList.add("allowed");
        let addr=`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        try{
          const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`,
            {headers:{"User-Agent":"TrainAssistant/1.0"}});
          const j=await r.json(); if(j.display_name) addr=j.display_name;
        }catch{}
        addMsg(`<div><img src="${dataURL}" style="max-width:100%;border-radius:6px"></div>
                <div class="meta"><i class='fas fa-map-marker-alt'></i> ${addr}</div>`,"user");
        const answer=await askGPTWithImage(dataURL,lat,lon,addr);
        addMsg(answer,"bot");
      },
      err=>{
        locationLamp.classList.add("denied");
        addMsg(`<div><img src="${dataURL}" style="max-width:100%;border-radius:6px"></div>
                <div class="meta"><i class='fas fa-map-marker-alt'></i> Couldnâ€™t get location (${err.message})</div>`,"user");
        askGPTWithImage(dataURL,null,null,"Location unavailable").then(a=>addMsg(a,"bot"));
      },
      {enableHighAccuracy:true,timeout:6000});

      setTimeout(()=>{isCapturing=false;captureBtn.disabled=false;captureBtn.style.opacity=1;},2000);
    }

    async function askGPT(question){
      const messages=[
        {role:"system",content:`Role:
You are a station staff member in Japan who assists foreign visitors at train stations.
Behavior Rules:
1. If the user sends only an image, reply briefly to confirm receipt (e.g., â€œIâ€™ve received your photo. Please tell me your question.â€).
2. After receiving a question, use the image and GPS data to understand the situation and answer.
3. Always give the conclusion first, then provide a short and clear explanation.
4. Keep responses simple, polite, and easy to understand in English.
5. Do not add unnecessary text, emojis, or translations unless asked.
6. Focus on providing accurate information and ensure sources can be referenced.(no need to show)
Language:
Respond only in English.
Tone:
Helpful, calm, and concise â€” like a professional station attendant assisting a traveler.`},
        {role:"user",content:question}
      ];
      try{
        const resp=await fetch("/api",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({model:"gpt-5",messages})});
        const data=await resp.json();
        if(data.error)return "âš ï¸ API Error: "+data.error.message;
        const content=data.choices?.[0]?.message?.content;
        return content||"âš ï¸ No valid response.";
      }catch(err){return "âš ï¸ "+err.message;}
    }

    async function askGPTWithImage(imageData,lat,lon,address){
      const messages=[{
        role:"system",
        content:`Role:
You are a station staff member in Japan who assists foreign visitors at train stations.
Behavior Rules:
1. If the user sends only an image, reply briefly to confirm receipt (e.g., â€œIâ€™ve received your photo. Please tell me your question.â€).
2. After receiving a question, use the image and GPS data to understand the situation and answer.
3. Always give the conclusion first, then provide a short and clear explanation.
4. Keep responses simple, polite, and easy to understand in English.
5. Do not add unnecessary text, emojis, or translations unless asked.
6. Focus on providing accurate information and ensure sources can be referenced.(no need to show)
Language:
Respond only in English.
Tone:
Helpful, calm, and concise â€” like a professional station attendant assisting a traveler.`
      },{
        role:"user",
        content:[
          {type:"text",text:`This image was taken at ${address||"an unknown location"} (${lat||"?"}, ${lon||"?"}). Please analyze the sign and give your response following the station staff behavior rules.`},
          {type:"image_url",image_url:{url:imageData}}
        ]
      }];
      try{
        const resp=await fetch("/api",{method:"POST",headers:{"Content-Type":"application/json"},
          body:JSON.stringify({model:"gpt-5",messages})});
        const data=await resp.json();
        if(data.error)return "âš ï¸ API Error: "+data.error.message;
        const content=data.choices?.[0]?.message?.content;
        return content||"âš ï¸ No valid response.";
      }catch(err){return "âš ï¸ "+err.message;}
    }

    captureBtn.onclick=captureNow;
    sendBtn.onclick=async()=>{const t=input.value.trim();if(!t)return;addMsg(t,"user");input.value="";addMsg(await askGPT(t),"bot");};
    toggleSizeBtn.onclick=()=>{document.getElementById('previewBox').classList.toggle("expanded");};
    switchBtn.onclick=()=>{usingRear=!usingRear;initCamera(usingRear?"environment":"user");};
    clearBtn.onclick=()=>{chat.innerHTML='';menu.style.display='none';};
    menuBtn.onclick=()=>{menu.style.display=menu.style.display==='block'?'none':'block';};
    document.addEventListener('click',e=>{if(!menu.contains(e.target)&&e.target!==menuBtn)menu.style.display='none';});

    // Speech recognition
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(SR){
      const recognition=new SR(); recognition.lang='en-US';
      recognition.onresult=async e=>{
        const t=e.results[0][0].transcript;
        addMsg(t,'user'); addMsg(await askGPT(t),'bot');
      };
      recognition.onerror=e=>addMsg("ðŸŽ¤ Error: "+e.error,'bot');
      micBtn.onclick=()=>{recognition.start();addMsg("ðŸŽ¤ Listening...","bot");};
    }else{micBtn.disabled=true;micBtn.title="Speech recognition not supported";}

    initCamera('environment');
  </script>
</body>
</html>
