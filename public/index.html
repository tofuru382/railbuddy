<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Train Assistant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    html, body { touch-action: none; height: 100%; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Roboto, Arial, sans-serif; background: #f5f5f5; color: #333; display: flex; align-items: center; justify-content: center; }
    .device { width: 100%; max-width: 420px; height: 100%; background: #fff; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, .08); display: flex; flex-direction: column; overflow: hidden; position: relative; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
    .topbar { display: flex; justify-content: flex-end; align-items: center; background: #fff; border-bottom: 1px solid #eee; padding: 10px 14px; position: relative; z-index: 2; }
    .menu-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #555; position: relative; z-index: 3; }
    .menu { display: none; position: absolute; top: 44px; right: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,.1); min-width: 180px; z-index: 5; padding: 6px 0; }
    .menu button { display: block; width: 100%; border: none; background: #fff; padding: 10px 14px; text-align: left; cursor: pointer; font-size: 14px; color: #333; transition: background .2s ease; }
    .menu button:hover { background: #f5f5f5; }
    .menu .lampRow { display: flex; align-items: center; gap: 6px; padding: 6px 14px; font-size: 13px; color: #555; }
    .lamp { width: 10px; height: 10px; border-radius: 50%; background: #bbb; }
    .lamp.allowed { background: #4caf50; }
    .lamp.denied { background: #f44336; }
    .previewWrap { background: #fafafa; border-bottom: 1px solid #eee; padding: 12px; }
    .previewBox { width: 100%; background: #000; border-radius: 8px; overflow: hidden; height: 220px; transition: height 0.4s ease; margin-bottom: 12px; }
    .previewBox.expanded { height: 400px; width: 100%; border-radius: 8px; }
    .previewBox.expanded video { object-fit: contain; width: 100%; height: 100%; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .previewControls, .inputBar { display: flex; flex-direction: row; justify-content: space-between; gap: 10px; padding: 0 10px; }
    .btnControl, .btnBlue, .btnGhost { flex: 1; border-radius: 14px; font-weight: 600; font-size: 14px; cursor: pointer; text-align: center; }
    .btnControl { border: none; width: 44.5px; height: 44.5px; transition: background .2s ease; display: flex; align-items: center; justify-content: center; }
    .btnControl.blue { background: #4285f4; color: #fff; }
    .btnControl.blue:hover { background: #3367d6; }
    .btnControl.ghost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnControl.ghost:hover { background: #f5f5f5; }
    .chat { flex: 1; overflow: auto; padding: 12px; background: #fff; display: flex; flex-direction: column; gap: 8px; }
    .row { display: flex; }
    .bubble { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
    .bot .bubble { background: #f0f0f0; color: #333; border-top-left-radius: 4px; }
    .user { justify-content: flex-end; }
    .user .bubble { background: #4285f4; color: #fff; border-top-right-radius: 4px; }
    .inputWrap { flex: 3; position: relative; display: flex; align-items: center; }
    .textIn { flex: 1; border-radius: 14px; padding: 12px 36px 12px 12px; border: 1px solid #ddd; font-size: 15px; background: #fff; }
    .textIn::placeholder { color: #aaa; }
    .micIcon { position: absolute; right: 10px; background: none; border: none; font-size: 16px; color: #666; cursor: pointer; }
    .btnBlue, .btnGhost { padding: 10px 0; }
    .btnBlue { background: #4285f4; color: #fff; border: none; }
    .btnBlue:hover { background: #3367d6; }
    .btnGhost { background: #fff; color: #4285f4; border: 1px solid #4285f4; }
    .btnGhost:hover { background: #f5f5f5; }
    .mapFrame { border: 0; border-radius: 6px; width: 100%; height: 120px; margin-top: 4px; }
  </style>
</head>
<body>
  <div class="device">
    <div class="topbar">
      <button class="menu-btn" id="menuBtn"><i class="fas fa-ellipsis-h"></i></button>
      <div class="menu" id="menu">
        <button id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
        <button id="clearBtn"><i class="fas fa-trash"></i> Clear Messages</button>
        <div class="lampRow"><div id="cameraLamp" class="lamp"></div> Camera</div>
        <div class="lampRow"><div id="locationLamp" class="lamp"></div> Location</div>
      </div>
    </div>

    <section class="previewWrap" id="previewWrap">
      <div id="previewBox" class="previewBox">
        <video id="camera" autoplay playsinline muted></video>
      </div>
      <div class="previewControls">
        <button id="zoomIn" class="btnControl ghost"><i class="fas fa-search-plus"></i></button>
        <button id="zoomOut" class="btnControl ghost"><i class="fas fa-search-minus"></i></button>
        <button id="flicker" class="btnControl blue" style="font-size:12px;">Anti-Flickering</button>
        <button id="toggleSize" class="btnControl ghost"><i class="fas fa-expand-arrows-alt"></i></button>
        <button id="switchCamera" class="btnControl ghost"><i class="fas fa-sync-alt"></i></button>
      </div>
    </section>

    <main id="chat" class="chat">
      <div class="row bot"><div class="bubble">Welcome! I’ll help you read departure boards, tickets, or gate messages. Capture the sign, and I’ll guide you step by step.</div></div>
    </main>

    <footer class="inputBar">
      <div class="inputWrap">
        <input id="userInput" class="textIn" placeholder="Message…" autocomplete="off" />
        <button id="micBtn" class="micIcon"><i class="fas fa-microphone"></i></button>
      </div>
      <button id="capture" class="btnGhost"><i class="fas fa-camera"></i></button>
      <button id="send" class="btnBlue"><i class="fas fa-paper-plane"></i></button>
    </footer>
  </div>

  <canvas id="snapshot" style="display:none;"></canvas>

  <script>
    const video=document.getElementById('camera');
    const chat=document.getElementById('chat');
    const input=document.getElementById('userInput');
    const previewBox=document.getElementById('previewBox');
    const canvas=document.getElementById('snapshot');

    const zoomInBtn=document.getElementById('zoomIn');
    const zoomOutBtn=document.getElementById('zoomOut');
    const flickerBtn=document.getElementById('flicker');
    const toggleSizeBtn=document.getElementById('toggleSize');
    const switchBtn=document.getElementById('switchCamera');
    const captureBtn=document.getElementById('capture');
    const sendBtn=document.getElementById('send');
    const menuBtn=document.getElementById('menuBtn');
    const menu=document.getElementById('menu');
    const clearBtn=document.getElementById('clearBtn');
    const micBtn=document.getElementById('micBtn');
    const cameraLamp=document.getElementById('cameraLamp');
    const locationLamp=document.getElementById('locationLamp');

    let stream;let usingRear=true;let currentTrack;let currentZoom=1;let maxZoom=1;
    let lastImageData=null;
    let lastLocationData=null;

    function addMsg(html,who='user'){
      const row=document.createElement('div');
      row.className='row '+(who==='user'?'user':'bot');
      const b=document.createElement('div');b.className='bubble';b.innerHTML=html;row.appendChild(b);
      chat.appendChild(row);chat.scrollTop=chat.scrollHeight;
    }

    async function initCamera(facing='environment'){
      try{
        if(stream){stream.getTracks().forEach(t=>t.stop());}
        stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:facing}}});
        cameraLamp.classList.add('allowed');
      }catch{
        try{ stream=await navigator.mediaDevices.getUserMedia({video:true}); cameraLamp.classList.add('allowed'); }
        catch(err){console.error(err);cameraLamp.classList.add('denied');}
      }
      if(stream){
        video.srcObject=stream;currentTrack=stream.getVideoTracks()[0];
        const caps=currentTrack.getCapabilities?currentTrack.getCapabilities():{};
        maxZoom=caps.zoom?.max||1;
        currentZoom=currentTrack.getSettings().zoom||1;
      }
    }

    function captureNow(){
      if(!stream){addMsg('Camera is not available.','bot');return;}
      canvas.width=video.videoWidth||720;canvas.height=video.videoHeight||1280;
      const ctx=canvas.getContext('2d');ctx.drawImage(video,0,0,canvas.width,canvas.height);
      const dataURL=canvas.toDataURL('image/jpeg',0.9);
      lastImageData=dataURL;

      navigator.geolocation.getCurrentPosition(async pos=>{
        const lat=pos.coords.latitude,lon=pos.coords.longitude;
        locationLamp.classList.add('allowed');
        let addr=`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
        try{ 
          const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}`, {
            headers: { "User-Agent": "TrainAssistant/1.0" }
          }); 
          const j=await r.json(); if(j.display_name) addr=j.display_name; 
        } catch(e){}
        lastLocationData={ lat, lon, address:addr };

        addMsg(`<div><img src="${dataURL}" style="max-width:100%;border-radius:6px"></div>
                <div class="meta"><i class='fas fa-map-marker-alt'></i> ${addr}</div>
                <iframe class="mapFrame" loading="lazy" src="https://www.google.com/maps?q=${lat},${lon}&hl=en&z=15&output=embed"></iframe>`, 'user');
      }, err=>{
        locationLamp.classList.add('denied');
        addMsg(`<div><img src="${dataURL}" style="max-width:100%;border-radius:6px"></div>
                <div class="meta"><i class='fas fa-map-marker-alt'></i> Couldn’t get location.</div>`, 'user');
      }, {enableHighAccuracy:true,timeout:6000});
    }

    async function askGPT(question) {
  const messages = [
    { role: "system", content: "You are a train assistant for foreign tourists in Japan." },
    { role: "user", content: question }
  ];

  try {
    const resp = await fetch("/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ model: "gpt-4o-mini", messages })
    });

    if (!resp.ok) {
      return `⚠️ API Error: HTTP ${resp.status} ${resp.statusText}`;
    }

    const data = await resp.json();
    console.log("API response:", data); // 👈 log full response for debugging

    if (data.error) {
      return `⚠️ API Error: ${data.error.message || JSON.stringify(data.error)}`;
    }

    // ✅ Handle both new and old formats
    const choice = data.choices?.[0];
    if (choice?.message?.content) {
      return choice.message.content;
    }
    if (choice?.message?.[0]?.text) {
      return choice.message[0].text;
    }
    if (choice?.delta?.content) {
      return choice.delta.content;
    }

    return "⚠️ Unexpected API response: " + JSON.stringify(data, null, 2);
  } catch (err) {
    console.error("Network/API fetch error:", err);
    return "⚠️ Network error: " + (err.message || err.toString());
  }
}

    zoomInBtn.onclick=()=>{if(!currentTrack)return;const caps=currentTrack.getCapabilities?currentTrack.getCapabilities():{};if(caps.zoom){const s=currentTrack.getSettings();const next=Math.min((s.zoom||1)+0.2,caps.zoom.max);currentTrack.applyConstraints({advanced:[{zoom:next}]});}};
    zoomOutBtn.onclick=()=>{if(!currentTrack)return;const caps=currentTrack.getCapabilities?currentTrack.getCapabilities():{};if(caps.zoom){const s=currentTrack.getSettings();const next=Math.max((s.zoom||1)-0.2,caps.zoom?.min||1);currentTrack.applyConstraints({advanced:[{zoom:next}]});}};
    flickerBtn.onclick=()=>{addMsg('Anti-flicker toggle pressed.','bot');};
    toggleSizeBtn.onclick=()=>{previewBox.classList.toggle('expanded');};
    switchBtn.onclick=()=>{usingRear=!usingRear;initCamera(usingRear?'environment':'user');};
    captureBtn.onclick=captureNow;

    sendBtn.onclick=async()=>{
      const t=input.value.trim();if(!t)return;
      addMsg(t,'user');input.value='';
      const answer=await askGPT(t);
      addMsg(answer,'bot');
    };

    menuBtn.onclick=()=>{menu.style.display=(menu.style.display==='block'?'none':'block');};
    clearBtn.onclick=()=>{chat.innerHTML='';menu.style.display='none';};

    // Close menu on outside click
    document.addEventListener('click', e => {
      if (!menu.contains(e.target) && e.target !== menuBtn) {
        menu.style.display = 'none';
      }
    });

    // Mic support
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    if(SR){
      recognition=new SR();
      recognition.lang='en-US';
      recognition.continuous=false;
      recognition.interimResults=false;
      recognition.onresult=async(event)=>{
        const transcript=event.results[0][0].transcript;
        input.value=transcript;
        addMsg(transcript,'user');
        const answer=await askGPT(transcript);
        addMsg(answer,'bot');
      };
      recognition.onerror=(event)=>{ addMsg("🎤 Error: "+event.error,'bot'); };
      micBtn.onclick=()=>{ recognition.start(); addMsg("🎤 Listening...",'bot'); };
    } else {
      micBtn.disabled=true;
      micBtn.title="Speech recognition not supported";
    }

    // Initialize camera on load
    initCamera('environment');
  </script>
</body>
</html>

